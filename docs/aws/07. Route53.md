---
layout: default
title: 07. Route53
parent: aws
---
# 07. Route53
---
## DNS

ip 주소를 사람들에게 친숙하게 변환

- Domain Registrar
	- Amazon Route 53, GoDaddy ... 
- DNS Records
	- A, AAAA, CNAME, NS
- Zone File
	- 모든 DNS 레코드를 포함하는 존 파일
	- 호스트 이름과 ip주소를 일치시키는 방법
- Name Server
	- DNS 쿼리를 실제로 해결하는 서버
- 최 상위 도메인
	- .com, .us, .in, .gov, .org ...
- 2단계 도메인
	- amazon.com, google.com
	- 단어사이에 . 존재
- `http://api.www.example.com.`
	- 마지막 .을 도메인 이름의 루트라고 한다
	- .com은 TLD(최상위 도메인)이다
	- example.com이 2단계 도메인이다
	- www.example.com은 서브도메인
	- api.www.example.com이 도메인 이름이다?
	- http == 프로토콜
	- 전체를 FQDN이라고 부름
	- Fully Qualified Domain Name

---

## 동작

```
1. Web Browser -(example.com)-> Local DNS Server

로컬 DNS 서버는 보통 회사에 의해 할당되고 관리된다
또는 인터넷 서비스 제공자에 동적으로 할당된다
```

```
2. Local DNS Server -(example.com)-> Root DNS server(ICANN)

로컬 DNS 서버가 이 쿼리를 전에 본적이 없다면 ICANN에 의해 관리된 DNS 서버의 루트에 물어본다
example.com 은 모르지만 .com은 알고있는 경우 NS(서버, 공인 IP 1.2.3.4) 레코드로 가보라고 알려준다
```

```
3. Local DNS Server -(example.com)-> TLD DNS Server(.com의 정보 소유 Managed by IANA)

TLD DNS Server는 example.com이라는 서브 도메인 정보를 가지고 있는 SLD DNS Server의 주소를 알려준다
```

```
4. Local DNS Server -(example.com)-> SLD DNS Server(Amazon Registarar, ...)

해당 요청의 결과로 example.com 의 ip 주소를 얻게되어 example.com으로 요청할 수 있게 된다.
Local DNS는 이제 example.com에대한 정보가 생겨 다시 요청하면 바로 대답해 줄 수 있다
```

---

## Route53
(53은 DNS에 사용되는 포트를 의미)

고가용성, 확장성을 갖춘 완전히 관리되며 권한있는 DNS이다

>권한이란?
>고객인 우리가 DNS 레코드를 업데이트 할 수 있다는 것

100% SLA 가용성을 제공하는 유일한 AWS 서비스이다.

레코드 설정
- 도메인, 서브도메인
- Record Type
	- A, AAAA, CNAME, NS
	- (고급) CAA / DS / MX / NAPTR / PTR / SOA / TXT / SPF / SRV
- 레코드의 값
- 라우팅 정책 (쿼리에 응답하는 방식)
- TTL (DNS 리졸버에 레코드가 캐싱되는 시간)

---

### Record Type

- A
	- 호스트 이름과 IPv4 IP를 매핑
	- example.com -> 1.2.3.4 연결
- AAAA
	- 호스트 이름을 IPv6 주소에 매핑
- CNAME
	- 다른 호스트 이름과 매핑
	- 대상 호스트 이름은 A 또는 AAAA가 될 수 있다
	- 상위 노드 DNS에 대한 CNAMES를 생성할 수 없다?
	- 예를 들어 example.com에 CNAME을 만들 수 없지만, www.example.com에 대한 CNAME레코드는 만들 수 있다
-  NS
	- 서버의 DNS이름 또는 IP주소로 호스팅 존에대한 DNS쿼리에 응답할 수있다
	- 또한 트래픽이 도메인으로 라우팅 되는 방식을 제어한다


### Hosted Zones

호스팅 존은 레코드의 컨테이너이다
도메인과 서브도메인으로 가는 트래픽의 라이팅 방식을 정의한다

aws에서 만든 어떤 호스팅존이든 월에 50센트를 지불해야한다
#### public hosted zones
퍼블릭 도메인을 구매하면 퍼블릭 호스팅 존을 만들 수 있다 

퍼블릭 호스팅 존은 공개된 클라이언트로부터 온 쿼리에 응답할 수 있다
웹브라우저에서 example.com을 요청하면 ip를 반환한다


#### private hosted zones

공개되지 않는 도메인 이름을 지원한다
가상 프라이빗 클라우드(VPC)만이 URL을 리졸브 할 수 있다


---

## CNAME vs Alias

로드 밸런서나 CloudFront 등 AWS의 리소스를 사용하는 경우 호스트의 이름이 노출된다
lb-1234.us-east-2.elb.amazonaws.com
이를 myapp.mydomain.com에 매핑하고싶은경우 두가지 옵션이 있다

CNAME
- 호스트 이름이 다른 호스트 이름으로 향하도록 할 수 있다
- 예를들어 app.mydomain.com이 blabla.anything.com으로 향하게끔 할 수 있다
- 루트 도메인 이름이 아닌 경우에만 가능해서 mydomain.com앞에 뭔가 붙어야한다

Alias
- Route53 한정 호스트 이름이 특정 AWS 리소스를 향하도록 할 수 있다
- app.mydoamin.com이 blabla.anyting.com으로 향하게 할 수 있다 (리소스라며 왜 예제를 도메인으로들어?)
- 루트 및 비루트 도메인 모두에 작동한다
- 시험에 출제될 수 있다
- 무료이다
- 자체적으로 상태 확인이 가능하다
- AWS의 리소스에만 매핑이 되어있다
- CNAME과 달리 별칭 레코드는 Zone Apex라는 DNS 네임스페이스의 상위 노드로 사용될 수 있다
- AWS리소스를 위한 별칭 레코드의 타입은 항상 A또는 AAAA인데 별칭 레코드를 사용하면 TTL을 설정할 수 없다
>-TTL (DNS 리졸버에 레코드가 캐싱되는 시간)
- 레코드 대상
	- ELB
	- CloudFront
	- API Gateway
	- Beanstalk
	- S3 websties (버킷은 안됨)
	- VPC interface endpoints
	- Global Accelerator
	- Route 53 Record
	- EC2의 DNS 이름에 대해서는 별칭 레코드를 설정할 수 없다 (중요)

---

## Routing Policies
라우팅 정책

DNS는 트래픽을 라우팅하지 않는다???

### 단순 라우팅 정책

- 일반적으로 트래픽을 단일 리소스로 보내는 방식
- foo.example.com으로 가고자한다면 해당 IP주소를 알려줌. 이는 A레코드
- 동일한 레코드에 여러개의 값을 지정하는것도 가능하지만 반환은 랜덤이다
- 별칭과 함께 사용하면 하나의 AWS리소스만을 대상으로 지정할 수 있다
- 상태확인은 불가능하다


### 가중치기반 라우팅 정책

- 가중치를 활용해 일부 비율을 특정 리소스로 보내는 제어가 가능
- 비율은 합해서 100%가 아니여도 된다(그이상이여도 가능)
- 서로 다른 지역들에 걸쳐 로드 밸런싱을 할때나 적은 양의 트래픽을 보내 새 어플리케이션을 테스트하는 경우에 사용
- 모든 리소스의 레코드 가중치가 0인경우 모든 레코드가 다시 동인한 가중치를 갖게된다

### 지연 시간 기반 라우팅 정책

- 지연 시간이 가장 짧은 리소스로 리다이렉팅 하는 정책
- 지연시간이 민감한 웹사이트나 애플리케이션에서 사용
- 유저가 레코드로 가장 가까운 식별된 AWS 리전에 연결하기까지 걸리는 시간을 기반으로 측정
- 

### 지리적 위치 라우팅 정책

지연 시간 기반의 정책과 매우 다르게 사용자의 실제 위치를 기반으로 한다

일치하는 위치가 없는 경우 기본 레코드를 생성해야한다

### 지리 근접 라우팅 정책

사용자와 리소스의 지리적 위치를 기반으로 프래픽을 리소스로 라우팅한다

편향값을 사용해 특정 위치를 기반으로 리소스를 더 많은 트래픽을 이동한다 (편향값 증가 -> 트래픽 증가)

### IP기반 라우팅 정책

클라이언트 IP 주소를 기반으로 라우팅한다

Route53에서 CIDR 목록을 정의해야한다

CIDR에 따라 트래픽을 어느 로케이션으로 보내야하는지 정한다

네트워크 비용은 왜 절감되지?


### 다중값 라우팅 정책

트래픽을 다중 리소스로 라우팅할 때 사용

클라이언트에서 다중 값 쿼리를 실행하면 최대 8개의 레코드가 반환된다
ELB와 유사해보이지만 ELB를 대체할 수 없다

클라이언트 측면에서 로드 밸런싱이다

최대 8개의 레코드를 수신한 클라이언트는 하나를 선택해서 요청하게된다

단순 라우팅정책은 상태 확인을 허용하지 않기 때문에 리소스가 비정상일 가능성이 있지만, 다중 값은 이 부분에대해서 더 보완할 수 있다

## Route 53 상태 확인

주로 공용 리소스에 대한 상태를 확인하는 방법이다
개인 리소스의 상태 확인 방법 또한 존재

각 지역에 로드밸런서와 인스턴스가 떠있을떄
Route 53은 두개의 LB에 상황에 따라 요청을 보낼 수 있다
이때 한 지역이 사용 불가능이되면 그곳으로 유저의 요청을 보내지 말아야한다
그러기 위해서 Route 53에서 상태 확인을 생성해야한다

세가지의 상태확인이 가능하다
1. 공용 엔드포인트를 모니터링 (애플리케이션, 서버, 또다른 AWS리소스)
2. 계산된 상태 확인 (이게뭔데? 여러개의 상태 확인 결과를 하나로 합쳐주는기능)
3. CloudWatch 경보 상태 모니터링

상태 확인들은 각자의 메트릭을 사용한다

>메트릭이란?
>
>AWS에서는 다양한 서비스에서 다양한 유형의 메트릭을 수집할 수 있습니다. 예를 들어, Amazon EC2 인스턴스의 CPU 사용률, Amazon S3 버킷의 객체 수, Amazon RDS 데이터베이스의 연결 수 등이 모두 메트릭의 예시입니다.
>
>Amazon CloudWatch는 AWS에서 제공하는 주요 메트릭 및 로그 관리 서비스 중 하나입니다. CloudWatch를 사용하면 AWS 리소스의 성능을 모니터링하고, 트랜잭션 및 이벤트 로그를 수집하며, 메트릭 데이터를 시각적으로 표시하고 경고를 설정할 수 있습니다.


상태 확인이 특정 엔드포인트에서 어떻게 작용하는지?
ALB에 대한 eu-west-1의 상태 확인을 한다고 하면 aws의 상태 확인이 전 세계로부터 온다
이들은 우리가 루트를 설정한 공용 엔드 포인트로 모두 요청을 보낸다
200 OK 코드 또는 우리가 정의한 코드를 받으면 리소스는 정상으로 간주한다

시간 간격을 정기적으로 30초마다 또는 비용이 더들지만 10초마ㅏ다도 가능하다
HTTP, HTTPS와 TCP 등 많은 프로토콜을 지원한다
18% 이상의 상태 확인이 엔드포인트를 정상이라고 판단하면 Route53도 이를 정상이라고 간주한다

2xx 3xx의 코드를 받아야만 통과가 된다

텍스트 기반 응답일 경우 상태 확인은 응답의 처음 5120바이트를 확인한다. 응답 자체에 해당 텍스트가 있는지 보기 위해서이다

상태 확인이 애플리케이션 밸런서나 엔드포인트에 접근이 가능해야한다


계상된 상태 확인이란
여러개의 상태 확인 결과를 하나로 합쳐주는기능이다
EC2인스턴스가 3개있고 상태확인을 세개 생성할 수 있다
이 3개를 하위 상태 확인이라고 하고
하위 상태를 바탕으로 상위 상태 확인을 정의할 수 있다
합치기 위한 조건은 OR AND NOT이다
하위 상태는 256개까지 모니터링 할 수 있다
상태 확인을 통과해야 하는지도 지정할 수 있다 

개인 리소스의 상태는 CloudWatch 지표를 만들어 알람을 할당하는 식으로 문제를 해결할 수 있따


## Domain Registar vs DNS Server
타사 도메인 및 Route 53


Domain Registar를 통해 원하는 도메인 이름을 구매할 수 있다
매년 비용을 지불한다

Domain Registar를 통해 도메인을 등록하면 DNS 레코드 관리를 위한 DNS 서비스를 제공한다

Amazon 호스트 이름으로 DNS 이름을 등록했다면 DNS 레코드 관리를 위한 Route53 호스팅 존을 갖게된다.

하지만 Route53을 사용하지 않고 Amazon Registar를 사용해도된다

GoDaddy(not Amazon Registar)에서 도메인을 등록하고 Amazon의 Route53으로 관리할수도있다

