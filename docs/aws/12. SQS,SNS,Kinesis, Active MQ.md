---
layout: default
title: 12. SQS,SNS,Kinesis, Active MQ
parent: aws
---
# 12. SQS,SNS,Kinesis, Active MQ
---

대기열 모델 - SQS
pub/sub - SNS
실시간 스트리밍 - Kinesis

---

## SQS

시험에서 애플리케이션 분리에 대한 문제가 보이면 SQS를 떠올려라

무제한 처리량을 얻을 수 있다

처리량에 제한이 없고 대기열에 있는 메시지 수에도 제한이 없다

각 메시지는 수명이 짧다
메시지는 기본값으로 4일 동안 대기열에 남아 있고, 대기열에 있을 수 있는 최대 시간은 14일이다

지연시간이 매우 짧다.
보내거나 읽는경우 10밀리초 이내

전송된 메시지당 256KB 미만이여야 한다

SQS에는 중복 메시지가 있을 수 있다
애플리케이션에서는 이를 고려해야한다

SQS는 메시지를 처리할 소비자를 여럿 둘 수 있다
각 소비자는 poll 함수를 호출하여 다른 메시지를 수신한다
메시지가 소비자에 의해 빠르기 처리되지 않으면 다른 소비자가 수신한다. 그래서 적어도 한번은 전송된다 라는것

소비자는 메시지를 처리하면 메시지를 삭제해야한다. 안그러면 다른 소비자가 메시지를 처리한다.

더 많은 메시지량을 처리하려면 소비자를 추가하고 수평확장을 수행하면서 개선할 수 있다. (ASG : auto scaling groups)

SQS보안

HTTPS API를 사용하여 메시지를 보내고 생성함으로써 전송 중 암호화를 하고 KMS키를 사용하여 미사용 암호화를 얻고 ㅜ언한다면 클라리언트 측 암호화를 할 수 있다 

액세스 제어를 위해 IAM 정책은 SQS API에 대한 액세스를 규제할 수 있고, S3 버킷 정책과 유사한 SQS 액세서 정책도 있다

---

## Message Visibility Timeout
메시지 가시성 시간 초과

소비자가 메시지를 폴링하면 다른 소비자들에게 보이지 않게된다

기본값으로 메시지 가시성 시간초과는 30초이다
그 말은 이 30초 동안 메시지가 처리되어야한다 라는뜻
그리고 그 가시성 시간 초과 기간 내에서는 그 메시지가 다른 소비지한테 보이지 않는다.

소비자가 메시지를 처리하는데 시간이 더 필요하다는 것을 알리는 방법으로는 ChangeMessageVisibility라는 API가 있다

---

## Long Polling

소비자가 대기열에 메시지 요청을 하는데 대기열에 아무것도 없다면 메시지 도착을 기다린다
이것이 롱 폴링

1. 지연시간을 줄이기 위해
2. SQS로 보내는 api 호출 숫자를 줄이기 위해

대기열 레벨에서 구성하여 폴링하는 아무 소비자로부터 롱 폴링을 활성화하는 방법과
소비자 측에서 wait time seconds를 지정해서 하는 방법이 있다

---

## FIFO Queue

순서보장 대기열의 처리량에는 제한이 있다.

묶음이 아닐 경우 초당 300개의 메시지를 처리하고,

메시지를 묶음으로 보낸다면 처리량은 초당 3000개가 된다.

또한 중복을 제거하도록 해주는 기능이 있어 정확히 한번만 보낼 수 있게 해준다

---

## SQS with Auto Scaling Group

CloudWatch 지표인 대기열 길이를 보고 결정할 수 있다

ApproximateNumberOfMessage라고 하는 지표로 대기열에 몇개의 메시지가 남아 있는지 표시한다

특정 행사로 인해 주문이 밀리는 경우 쓰기 대상 데이터베이스에서 SQS를 버퍼로 사용할 수 있다
데이터 베이스에 바로 요청을 쓰는 대신 애플리케이션이 SQS대기열에 먼저 쓰는 방법이다.

이 패턴은 클라이언트에게 따로 데이터베이스에 쓰였다는 확인을 전송할 필요가 없을때만 가능하다

---

## SNS

메시지 하나를 여러 수신자에게 보낼때 사용

주제별로 최대 1200만 이상의 구독자까지 가능

계정당 가질 수 있는 주제 수는 최대 10만개이고 더 늘릴 수 있다
이런건 시험에 안나옴

SNS를 통해 이메일도 보낼 수 있고, 모바일 알림도 보낼 수 있다
또한 지정된 HTTP 또는 HTTPS엔드 포인트로 직접 데이터를 보낼 수도 있다

SQS와 통합하여 메시지를 대기열로 직접 보낼수도 있고 메시지를 수신한 후 함수가 코드를 수행하도록 lambda에 보내거나 firehose를 통해 데이터를 S3나 Redshift로 보낼 수 있다

SNS는 다양한 AWS서비스에서 데이터를 수신하기도한다
CloudWatch 경보 Auto Scaling 그룹 알림
CloudFormation State Changes Budgets, S3 버킷
DMS, Lambda, DynamoDB RDS 이벤트 등
서비스명은 시험에 안나온다

SNS 수신 가능 대상은 Google, GCM, Apple APNS 또는 Amazon ADM 구독자이다

기본적으로 전송 중 암호화와 KMS키를 사용한 저장 데이터 암호화가 있다

엑세스 제어는 IAM 정책 중심이다
모든 SNS API가 IAM 정책으로 규제된다

SNS 주제에 교차 계정 액세스 권한을 갖고너 S3이벤트와 같은 서비스가 SNS 주제에 작성할 수 있도록 허용하려는 경우 매우 유용


---

## SNS + SQS 

Fan Out 패턴

메시지를 여러 SQS 대기열로 보내고 싶은데 개별적으로 보내면 애플리케이션이 중간에 비정상적으로 종료된 경우 특정 SQS에 전달이 실패하거나 SQS대기열이 더 추가될 수 있다.

SNS 주제에 메시지를 전송한 후 원하는 수의 SQS대기열이 이 SNS주제를 구독하는것으로 해결할 수 있다

리전 간 전달도 가능하다

>Kinesis Data Firehose
>이거 뭔데?

SNS에도 FIFO를 적용할 수 있다

SNS의 기능중 메시지 필터링이 있다
이는 SNS 주제를 구독할 때 전송되는 메시지를 필터링하는데 사용되는 JSON 적책이다
구독에 어떤 필터링 정책도 없다면 모든 메시지를 받아들이는 것이 기본값이다

---

## Kinesis

키네시스를 활용하면 실시간 스트리밍 데이터를 손쉽게 수집하고 처리하여 분석할 수 있다

애플리케이션 로그, 계측, 웹사이트 클릭 스트림, IoT원격 측정 데이터 등


### Kinesis Data Stream

시스템에서 큰 규모의 데이터 흐름을 다루는 서비스

여러개의 샤드로 구성되어 있고 이 샤드는 1번,2번에서 N번까지 번호가 매겨진다
이건 사전에 프로비저닝해야한다

애플리케이션과같은 데이터 생성자는 kinesis에 레코드를 전달한다

레코드는 근복적으로 두가지 요소로 구성된다
파티션 키와 최대 1MB크기의 데이터 블롭

파티션 키는 레코드가 이용할 샤드를 결정하는데 사용,
데이터 블롭은 값 자체를 의미

생상자는 데이터를 스트림으로 보낼때 초당 1MB를 전송하거나 샤드당 1초에 천개의 메시지를 전송할 수 있다

샤드에 저장된 데이터를 처리하는 소비자에게 전송되는 레코드에는
파티션 키, 샤드에서 레코드의 위치를 나타내는 시퀀스 번호, 데이터 자체를 의미하는 데이터 블롭이 있다

소비자마다 샤드당 1초에 2MB씩 받을 수도 있다

정리하면 생산자가 Kinesis에 데이터를 전송하고 데이터는 잠시 거기에 머물면서 여러 소비자에게 읽힌다

보존기간은 1일에서 365사이로 설정할 수 있다
이 말은 데이터를 다시 처리하거나 확인할 수 있다는 뜻

일단 Kinesis로 들어오면 삭제할 수 없으며 불변성이다
데이터는 파티션키가 같은 메시지들은 같은 샤드로 들어가게 되어 키를 기반으로 데이터를 정렬할 수 있다


용량은 두가지가 있는데

프로비저닝 유형
샤드 수를 정하고 Api를 활용하거나 수동으로 조정한다

온디맨드형
프로비저닝을 하거나 용량관리를 할 피룡가 없다
시간에 따라 언제든 용량이 조정된다
기본적으로 초당 4MB 또는 4천개의 레코드를 처리
이 용량은 지난 30일동안 관측한 최대 처리량에 기반하여 자동으로 조정된다
시간당 송수신 데이터량(GB)에 따라 비용이 부과된다

이것은 리전 배포된다

IAM정책을 사용하여 샤드를 생성하거나 샤드에서 읽어들이는 접근 권한을 제어할 수 있다

모든 API요청은 CludTrail로 감시할 수 있다


### Kinesis Data Firehose

생산자에서 데이터를 가져올 수 있는 유용한 서비스 

애플리케이션, 클라이언트, SDK, KPL, Kinesis Agent 모두 Kinesis Data Firehose로 데이터를 보낼 수 있다


데이터를 전송하면 람다 기능을 활용해 데이터를 변환할지 선택이 가능하다

수신처는 세가지 종류가 있다

-  AWS 수신처
모든 데이터를 아마존 S3에 쓸수있다
데이터 웨어하우스인 아마존 레드시프트도있다
아마존 ElasticSearch 도 있다

- 써드 파티 파트너 수신처도 있다
데이터독, 스플렁크, 뉴렐릭, 몽고DB

- HTTP엔드포인트가 있는 자체 API를 보유하고있다면 커스텀 수신처로 데이터를 보낼 수 있다

데이터가 수신처로 전송되고나면 두가지 선택지가 있다
모든 데이터를 백업으로 S3에 저장
실패한 케이스만 S3에 저장


근 실시간으로 이루어진다
이유는 배치로 처리되기 때문에
적어도 1MB데이터가 있을때까지 기다린다

데이터 전환, 변환, 압축이 필요하다면 람다를 사용할수있다

스토리지가 따로 없어 반복하는 기능은 없다


## 정렬

Kinesis
파티션키

SQS
전송 순서대로 처리
>브로커가 한개란소리?
>맞네


---

## Amazon MQ

RabbitMQ와 ActiveMQ 두 가지 기술을 위한 관리형 메시지 브로커 서비스


MQ는 무한 확장이 가능한 SQS나 SNS처럼 확장성이 크지 않다

MQ는 서버에서 실행되므로 서버 문제가 있을 수 있다

고가용성을 위해 장애 조치와 함께 다중 AZ설정을 할 수 있다

MQ는 EFS에 마운드된다
