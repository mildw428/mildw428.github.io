---
layout: default
title: 02. EC2
parent: aws
---
# 02. EC2
---

### 최소한의 비용 사용

#### 대시보드

아래와 같은 과정을 통해 사용자도 비용 청구 정보에 접근 할 수 있다.
(루트 계정 로그인) - 우측 상단 계정 클릭 - my billing dashboard - (아래로 스크롤) 청구 정보에 접근하기 위한 IAM 사용자와 역할 편집 - Activate IAM Access

위의 과정이 옜날버전이라 사라진듯하다.
https://us-east-1.console.aws.amazon.com/billing/home#/account
해당 주소를 통해 접근해보자.
![[Pasted image 20231111131432.png]]
해당 페이지에 들어가면 위와같이 활성화 할수 있는 편집창이 있다.
잘 찾아보자.

이후 사용자 계정에서 청구서를 조회 할 수 있게 되며,
대시보드를 통해 서비스별로 청구된 가격을 볼 수 있으며, 사용되지 않는 서비스는 삭제되어야한다.

무료 등급의 경우 LNB에 Free Tier의 메뉴를 볼 수 있다.
해당 페이지에서는 각 서비스별 무료 사용량을 알 수 있으며 이를 활용하여 무엇을 잘 못 사용하고 있는지 여부를 확인 할 수 있다.


#### AWS 예산
비용에대한 알림을 받으려면 aws예산을 만들어야한다.
이를 통해 한도에 도달하기 직전에 알림을 받을 수 있다.

LNB에서 예산(Budgets) 클릭으로 해당 페이지에 접근하여 예산 생성을 진행

![[Pasted image 20231111132941.png]]
지출이 아예 없도록 관리해주는 템플릿도 존재한다!

![[Pasted image 20231111133102.png]]
아예 막는것은 아니고 예산이 1달러로 설정되어 비용이 발생하자마자 사용자에게 알려주는듯 하다.


---

### EC2
Elastic Compute Cloud

버추얼 머신 - EC2
스토리지 확장 - EBS
로드밸런서 - ELB
오토 스케일링 - ASG
방화벽 - Firewall rules
처음 설정 데이터 - Bootstrap script
- 부팅할때만 동작하고 동작하지않음
- 모든 명령어는 sudo로 동작함

---

#### 인스턴스 생성

ec2 콘솔 - instances  - lunch instances

![[Pasted image 20231111141455.png]]
>선택하고있는 옵션 말고 맨위의 옵션이 기본값인데 왜 저걸 선택했을까?
>그 이유는 영상이 옜날거라 해당 옵션이 없었다. 그냥 영상 따라서 진행해보자.

![[Pasted image 20231111141733.png]]
인스턴스 유형에따라 가격이 달라진다. (성능 선택)

![[Pasted image 20231111141918.png]]
ssh접근을 위한 key pair 생성

![[Pasted image 20231111142047.png]]
키 페어 유형은 암호화 방식을 선택하는것이며,
프라이빗 키 파일 형식은
`.pem` : mac, linux, after windows(7,8 이후) 에서 지원
`.ppk` : window7,8 or Putty에서 사용 적합


![[Pasted image 20231111142434.png]]
![[Pasted image 20231111142546.png]]

인스턴스 생성시 방화벽을 설정 할 수 있으며, 예제에서는 Create security group을 선택한다.
웹서비스를 위한 인스턴스이기 때문에 인터넷에서 HTPP 트래픽 허용을 체크하고, HTTPS는 따로 사용할 예정이 없기 때문에 체크하지 않는다.

![[Pasted image 20231111142906.png]]
스토리지 옵션에서 세부사항을 보게되면
`종료 시 삭제`의 옵션이 예로 되어있는데, 이는 인스턴스가 종료될때 데이터가 모두 삭제된다는 것을 의미하니 주의할것.

![[Pasted image 20231111143833.png]]
세부사항 옵션을 펼친뒤 스크롤을 쭉 내리면 사용자 데이터라는 옵션이 있다.
여기서 Bootstrap script를 작성 할 수 있다.

```bash
#!/bin/bash
# Use this for you're user data (script from top to bottom)
# install https (Linux 2 version)
yum update -y
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "<h1>Hello world from $(hostname -f)</h1>" > /var/www/html/index.html
```
위 스크립트 copy, paste

![[Pasted image 20231111144727.png]]
완료하고나면 퍼블릭 ip주소와 프라이빗 ip주소를 알 수 있다.
위 사진에서 퍼블릭 ip주소를 가렸지만, 사실 인스턴스가 중지되었다가 다시 실행되면 주소가 바뀌어 그럴필요가 없다.

![[Pasted image 20231111150604.png]]
퍼블릭 DNS로 접근하면 위와같은 페이지를 볼 수 있다.

>처음에 script를 잘못 작성해서 재부팅하면 될줄알았는데, 결국 인스턴스를 다시 만들었다. 해결 방법있는지 아시는분?

---

#### 인스턴스 타입

m5.2xlarge
- m : instance class (m은 범용이라는 뜻)
- 5 : generation
- 2xlarge : 크기 (크기가 클수록 더 많은 메모리와 cpu를 가짐)

범용의 인스턴스는 웹 서버나 코드 저장소와 같은 다양한 작업에 적합
컴퓨팅, 메모리, 네트워킹 간의 균형도 잘 맞음
>t 도 범용 인스턴스라는데?

고성능 프로세서 컴퓨터는 cpu를 뜻하는 c로 시작함
메모리 특화는 ram을 뜻하는 r로 시작함. 대용량 메모리는 x1 또는 z1으로 표현하기도함
스토리지 특화(DB 서버에 적합)은 i, g, h 로 시작함

---

### 보안 그룹(방화벽)

인스턴스에 들어오고 나가는 트래픽을 제어한다
허용 규칙만 포함한다

컴퓨터의 위치(ip)나 다른 보안 그룹을 참조해 규칙을 만들 수 있다.

#### 통제
- 포트
- ip
- 인바운드 규칙
- 아웃바운드 규칙

기본적으로 인바운드는 막혀있으며 아웃바운드는 모두 허용이다.
```
AWS에서 "인바운드(Inbound)" 및 "아웃바운드(Outbound)"는 네트워크 트래픽의 방향을 나타냅니다. 이 용어들은 일반적으로 다음과 같은 의미를 갖습니다.

1. **인바운드(Inbound):**
    - 인바운드 트래픽은 네트워크로 들어오는 데이터를 나타냅니다.
    - 예를 들어, 사용자가 웹 브라우저를 사용하여 웹 서버에 요청을 보내면 이는 웹 서버에 대한 인바운드 트래픽입니다.
2. **아웃바운드(Outbound):**
    - 아웃바운드 트래픽은 네트워크에서 나가는 데이터를 나타냅니다.
    - 예를 들어, 서버가 클라이언트에게 응답을 보내는 것은 아웃바운드 트래픽입니다.
```

**허용되지 않은 포트로 접근하면 time out**

인스턴스는 여러 보안 그룹을 가질 수 있다.
보안 그룹은 지역과 vpc 결합으로 통제되어 있어, 지역이 바뀌면 새 보안그룹을 생성하거나 다른 vpc를 생성해야한다.

>VPC란?
>VPC(Virtual Private Cloud)는 Amazon Web Services (AWS)에서 제공하는 가상 네트워크 환경을 나타냅니다. VPC는 사용자가 정의하고 구성할 수 있는 가상의 네트워크로, AWS 클라우드에서 리소스를 배치하고 네트워크를 구축할 수 있게 해줍니다. 간단히 말해, AWS에서 제공하는 클라우드 환경에서 사용자가 자신만의 가상 네트워크를 생성할 수 있는 서비스입니다.

보안그룹은 ec2 외부에서 동작하는것이므로 ec2 인스턴스는 인지 할 수 없다.

ssh 액세스를 위해 하나의 별도 보안그룹을 유지하는 것이 좋다. (복잡하기 때문에 별도 관리)

**타임아웃으로 연결이 실패된거라면 보안그룹을 의심해보는것이 좋다.**

**연결이 거부됐다면, 트래픽은 통과했지만 애플리케이션에 문제가 있거나 실행되지 않는등의 이슈로 볼 수 있다.**

보안 그룹 사용의 예로

A인스턴스에 보안그룹1 (보안그룹1과 보안그룹2의 인바운드 허용)을 설정하고
B인스턴스에 보안그룹2만 적용해 둔다면 두 인스턴스는 간단하고 자유롭게 통신이 가능하다.
C인스턴스도 마찬가지로 보안그룹1을 설정한다면 A인스턴스와 B인스턴스 자유롭게 통신이 가능하다.
IP에 구에받지않고..!
D인스턴스가 보안그룹3을 설정하고 A,B,C가 통신한다면 같은 포트로 접근 했더라도 실패한다.

---
### 어떤 포트를 알아야 할까?

SSH : 22 :  secure shell
FTP : 21 : file transfer protocol
SFTP : 22 : secure file transfer protocal
HTTP : 80 : access unsecured website
HTTPS : 443 : access secured website
RDP : 3389 : remote desktop protocol

---

보안 그룹 설정 

네트워크 및 보안 - 보안 그룹
![[Pasted image 20231111160350.png]]
위 사진과 같이 규칙을 변경 할 수 있다.

---

### ssh

명령줄로 아마존 서버를 컨트롤

`.pem` 또는 `.ppk`파일 필요, 파일 이름에 공백이 있어선 안됨.

인스턴스의 외부망 주소가 필요하며, 해당 인스턴스는 ssh 포트인 22번 포트가 허용된 보안 그룹에 속해있어야함.

```shell
ssh ec2-user@{외부망 주소}
```
ec2-user라고 하는 이유는 Amazon Linux 2 AMI에는 이미 사용자가 하나 설정되어있는데 그 사용자 이름이 ec2-user이기 때문이다.

해당 명령어를 실행하면 실패 할텐데 이유는 `.pem`파일을 적용하지 않았기 때문이다.

```shell
ssh -i {파일이름.pem} ec2-user@{외부망 주소}
```
해당 파일이 있는 위치에서 위의 명령어 실행

![[Pasted image 20231111162235.png]]

보호되지 않은 키 파일이 있다고 뜬다. 우리는 이것의 권한을 변경 해야 한다
```shell
chmod 0400 EC2Tutorial.pem
```
![[Pasted image 20231111162523.png]]
다시 명령어를 실행하면 ssh 접속에 성공 한다.

---

### 인스턴스에 role 부여하기

인스턴스 - Actions - Security - Modify IAM Role

![[Pasted image 20231111163843.png]]


![[Pasted image 20231111163936.png]]
설정을 마치고 aws iam list-users를 실행하면 위 사진과 같은 리턴값을 받을 수 있다.

role을 부여하지않고 aws configure 명령어를 통해 access key 와 secret key를 입력해놓는다면
ssh로 연결하는 모든 사용자가 아무 권한이나 사용할 수 있기때문에 절대 해서는 안된다.

---

#### ec2 구매 옵션

#### EC2 on Demand
- Linux, windows - 1초 단위로 청구됨
- other - 1시간 단위로 청구됨

>EC2 On-Demand 인스턴스는 다음과 같은 특징을 가지고 있습니다.
>1. **순간적인 확장성**: 필요에 따라 인스턴스를 즉시 프로비저닝하여 애플리케이션 요구 사항에 대응할 수 있습니다.
>2. **시간당 청구**: 사용한 만큼만 지불하며, 인스턴스를 중지하면 과금이 중단됩니다.
>3. **가격의 예측 가능성**: 고정된 요금 모델이 아니라 사용한 시간에 비례하여 지불하므로 예측 가능한 비용 모델을 제공합니다.

#### EC2 Reserved Instances
- 온디맨드에 비해 72%할인을 제공
- 특정한 인스턴스 속성 예약 (인스턴스타입, 리전, 테넌시, OS 등)
- 계약 기간을 1년 또는 3년으로 지정해서 더 많은 할인
- 선결제, 부분선결제, 후불로 나뉠 수 있고 할인률이 다르다

#### Convertible Reserved Instances
- 인스턴스의 속성을 바꿀 수 있다.
- 그냥 예약제보다 할인률이 떨어진다.

#### EC2 Saving Plans
- 최대 70% 할인
- 1년내지 3년동안 시간당 10달러로 약정
- 한도를 넘어가면 온디맨드 타입으로 변경됨
- 사양을 선택해서 인스턴스를 생성하지만 고정이다

#### EC2 Spot Instances
- 최대 90% 할인
- 지불하려는 최대가격을 설정하고, 그 가격이 넘어가면 인스턴스가 손실된다.
- 사용 시간이 유연하고, 중요하지않은 작업 처리(DB같은 역할은 해서는 안됨)
- 중단 또는 종료 후 새로운 인스턴스로 띄우는 옵션이 있다. 유애기간은 2분
- 스팟 블록
	- 1~6시간만 동작하는 조건으로 인스턴스를 회수하지 않는다.
- 스팟 인스턴스는 1회성과 영구성이 있다.
	- 1회성은 한번 실행후 인스턴스가 종료되면 다시 실행시키지 않는다.
	- 영구성은 인스턴스가 종료되면 이를 감지하고 다시 실행시킨다.
		- 영구성 스팟으로 설정했을경우 스팟 요청먼저 취소하고 인스턴스를 종료해야 스팟 요청이 다시 인스턴스를 실행시키지 않는다.
#### 스팟 플릿(무리)
- 정의한 가격으로 다양한 런치 풀을 설정한다(인스턴스타입, 용량, 성능 등)
- 플릿은 가장 적합한 런치 풀을 선택한다.
- 원하는 예산 또는 용량에 도달하면 정지한다.
- 스팟 플릿은 가장 낮은 가격인 풀에서 인스턴스를 시작하기 때문에 비용이 최적화된다.
- 워크로드가 매우 짧은 경우 좋은 옵션이다. 
- 다양한 방법으로 스팟 인스턴스를 실행 할 수 있다.
- 원하는 인스턴스 유형과 AZ를 정확히 알고있는 경우 효율이 좋다.

#### EC2 Dedicated Hosts
- 전용 호스트
- 가장 비싼 옵션
- 라이선싱 모델과 함께 제공되는 소프트웨어인 경우, 규정이나 법규를 반드시 준수해야 하는 회사를 갖고있는경우

#### EC2 Dedicated Instance
- 전용 하드웨어에서 실행
- 같은 계정에서 다른 인스턴스와 함께 하드웨어를 공유 할 수 있다.
- 인스턴스 배치에 대한 통제권은 없다

#### EC2 Capacity Reservations
- 용량 예약
- 원하는 기간동안 특정한 AZ에서 온디맨드 인스턴스를 예약할 수 있다.
- 기간 약정이 없으며 언제라도 용량을 예약하고 취소 할 수 있다.
- 사용하지 않더라도 요금이 부가된다.
- 단기간이고 지속적으로 사용되야할때 사용

>Availability Zone
>가용 영역은 각각 고유한 식별자로 구분되며, 일반적으로 "us-east-1a", "us-east-1b"와 같이 표현됩니다. 이렇게 각각의 가용 영역은 AWS 클라우드의 물리적 분리와 격리를 제공하여 고가용성 및 내결함성을 강화합니다.

---

