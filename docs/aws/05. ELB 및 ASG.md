---
layout: default
title: 05. ELB 및 ASG
parent: aws
---
# 05. ELB 및 ASG
---

## 수직 확장성 Vertical scalability

인스턴스의 크기를 확장
데이터베이스와 같이 분산되지 않은 시스템에서 사용
하드웨어 용량 증가에 한계가 있다


## 수평 확장성 - 탄력성

시스템 수를 늘리는 방법
수평 확장을 했다는건 분배 시스템이 있다는것을 의미


## 고가용성

고가용성은 수평확장이랑 함께 사용되는 개념이지만 늘 그런것은 아니다

고가용성이란 애플리케이션 또는 시스템을 적어도 둘 이상의 aws의 az나 데이터 센터에서 가동중이라는것을 의미

고가용성의 목표는 데이터 센터에서의 손실에서 살아남는것으로 센터 하나가 멈춰도 계속 작동이 가능하게끔 하는것이다

스케일 아웃 -> 늘림
스케일 인 -> 줄임


고가용성은 다중 AZ가 활성화 된 자동 스케일러 그룹이나 로드밸런서에서도 사용된다 

---

## 로드 밸런싱 Load Balancing

트래픽을 백엔드나 다운스트림 EC2 인스턴스 또는 서버들로 전달하는 역할을 한다


필요한 이유
- 다운스트림 인스턴스 부하분산
- 다인 액세스 지점(DNS) 노출
- 인스턴스 실패 핸들링
- HTTPS 트래픽 사용 가능
- 쿠키로 고정도를 강화
- 고가용성
- 클라우드 내에서 개인 트래픽과 공공 트래픽을 분리 할 수 있다.

앨라스틱 로드밸런서는 무조껀 쓰는 편이 좋다
자체 로드 밸런서를 마련하는것 보다 저렴
관리와 확장성 측면에서도 손쉽다
다수의 aws 서비스와 통홥되어있다

health check
정상 동작하는지를 체크
포트와 라우트에서 헬스체크가 이루어진다
```
protocol : HTTP
port : 4567
Endpoint : /health
```
200을 반환하지않으면 상태가 좋지못한것으로 인식하고 로드밸런서는 해당 인스턴스에 요청을 보내지 않는다.

## 로드밸런서 종류

- CLB (classic load balancer)
	- 구형 (2009년 출시)
	- HTTP, HTTPS, TCP, SSL
	- ~~권장하지 않음~~
	- ~~사용은 가능함~~
	- AWS에서 지원이 곧 끊길예정이며, 콘솔에서 사용할 수 없게된다
- ALB (application load balancer)
	- 신형 (2016년에 출시)
	- HTTP, HTTPS, webSocket
- NLB (network load balancer)
	- 2017년 출시
	- TCP, TLS, UDP
- GWLB (gateway load balancer)
	- 2020년 출시
	- 네트워크 레이어에서 사용
	- 3게층과 IP 프로토콜에서 작동


더 많은 기능을 가진 신형 로드 밸런서를 사용하는것을 권장

일부 로드밸런서들은 내부에 설정될 수 있어 네트워크에 개인적 접근이 가능하고 웹사이트와 같이 모두에 사용 가능한 외부 공공 로드밸런서도 있다.

## 로드 밸런서 보안 그룹

유저는 HTTP || HTTPS를 사용해 어디서든 로드 밸런서에 접근이 가능

인스턴스는 로드밸런서로부터 곧장 들어오는 트래픽만 허용해야 하기 때문에
EC2의 보안그룹 규칙은 HTTP에 80포트만 허용하며
IP범위로 허용이 아니라 보안그룹을 허용하도록 설정해야한다


---

## ALB

- 7계층, 즉 HTTP 전요 로드 밸런서
- 머신 간 다수 HTTP 애플리케이션의 라우팅에 사용된다. 이런 머신들은 대상 그룹이라는 그룹으로 묶이게 된다
- HTTP/2 와 WebSocket을 지원한다
- 리다이렉트를 지원 (HTTP -> HTTPS로 리다이렉트가 필요하다면 로드밸런서 영역에서 가능하다.)
- 라우팅
	- 경로 라우팅
		- example.com/users || example.com/post
	- URL 라우팅
		- one.example.com || other.example.com
	- 쿼리 문자열과 헤더기반 라우팅
	- example.com/users?id=123&order=fasle
- 마이크로 서비스나 컨테이너 기반 애플리케이션에 가장 좋은 로드밸런서이다
- 도커와 ECS의 경우 ALB가 가장 적합한 로드밸런서
- 동적 포트 리다이렉트 가능
- 클래식 로드밸런서의 경우는 인스턴수 갯수만큼 로드밸런서가 필요하다? but ALB는 1개로 처리 가능
 

## ALB의 대상 그룹

- EC2 (auto scalㄴing group) - HTTP
- ECS - HTTP
- lambda - HTTP
- ip주소들의 앞에도 위치할 수 있다.
	- 꼭 사설 ip만 가능
- 상태 확인은 대상 그룹 레벨에서 이뤄진다


ABL을 사용하는경우 로드밸런서에 고정 호스트 이름이 부여된다
애플리케이션 서버는 클라이언트의 ip를 직접 보지 못하며 클라이언트의 실제 ip는 X-Forwarded-For라고 불리는 헤더에 삽입된다.

---

## NLB

- 네트워크 로드밸런서는 L4 로드밸런서이므로 TCP와 UDP 트래픽을 다룰 수 있다.
- 성능이 매우 높다
- 초당 수백만건 처리 가능
- ALB 보다 지연시간 짧음 (alb 400 nlb 100)
- 가용역역별로 하나의 고정 ip를 갖는다
- 탄력적 ip를 사용할 수도 있다
- 1~3개의 ip로만 액세스할 수 있는 애플리케이션을 만들라는 문제가 나오면 nlb 옵션 고려
- 프리티어에 미포함

그룹 유형
- ec2
- ip주소 (프라이빗)
- alb 앞에도 가능 (nlb로 고정ip를 얻을 수 있음)
- tcp, http, https 프로토콜 지원

---

GWLB

L3 계층에서 동작
배포 및 확장과 aws의 타사 네트워크 가상 어플라이언스의 플릿 관리에 사용된다

모든 트래픽이 방화벽을 통과하게 하거나 침입 탐지 및 방지 시스템에 사용

IDPS나 심층 패킷 분석 시스템 또는 페이로드 조작 가능 (네트워크 수준에서)


사용 예제 (중요)
1. 사용자는 게이트웨이로 요청을한다
2. 게이트웨이는 들어온 트래픽에 대해 검증을 하는 인스턴스로 보낸다
3. 검증이 끝나면 인스턴스는 게이트웨이로 반환한다 (문제가 있는 트래픽은 드롭한다)
4. 게이트웨이는 원래 가야할 인스턴스로 트래픽을 전달한다

gwlb의 기능 2가지
1. 투명 네트워크 게이트웨이 (vpc의 모든 트래픽이 gwlb가 되는 단일 엔트리와 출구를 통과한다)
2. 대상 그룹의 가상 어플라이언스 집합에 전반적으로 트래픽을 분산해 로드 밸런서가 된다

포트번호는 6081번을 사용한다

---

## Sticky Session (고정 세션)

- 로드 밸런서에 2가지(회) 요청을 수행하는 클라이언트가 요청에 응답하기 위해 동일한 백엔드 인스턴스에 요청을 보내도록하는것
- CLB와 ALB에서 설정 가능
- 원리는 쿠키
- 세션같은 중요한 정보를 잃지 않기 위해 동일한 인스턴스를 사용하도록 한다
- 고정을 활성화 하면 백엔드 ec2 인스턴스 부하에 불균형을 초래할 수 있다
- 일부 인스턴스는 고정 사용자를 갖게된다

쿠키
- 애플리케이션
	- 사용자 정의 쿠키
		- 애플리케이션에서 생성
		- 타겟 그룹별로 이름이 생성
		- ALB에서 사용하느 예약어는 사용하면 안됨
		- AWSALB, AWSALBAPP, AWSALBTG
	- 애플리케이션 쿠키
		- 로드밸런서에서 생성
		- 애플리케이션 쿠키는 애플리케이션에서 기간 설정 가능 
		- AWSALBAPP
- 기간
	- 로드밸런서에서 생성
	- AWSALB, AWSELB

>AWSALB같은 이름을 외울 필요는 없다

---

## Cross-Zone Load Balancing
교차 영역 로드밸런싱

두개의 가용영역에 갯수가 다른 인스턴스가 존재할때
교차 영역 로드밸런싱을 사용하면 모든 인스턴스에 고르게 분산된다
>좋은데?

- alb는 교차 영역 로드밸런서가 기본적으로 켜져있다 (alb의 교차 영역 로드밸런싱은 비용이 들지않는다)
- 대상 그룹에서 비활성화 할 수 있다
- aws는 데이터를 다은 가용 역역으로 옮길때 비용이 청구되지만, alb는 교차 영역 로드밸런서가 기본 설정이기 때문에 AZ간의 데이터 이동에 비용이 들지 않는다
- nlb와 gwlb는 기본적으로 꺼져있기 때문에 교차 영역 로드밸런서를 사용하려면 비용이 든다
- clb는 기본 비활성이고 활성해도 비용이 들지 않는다


---

## SSL / TLS

개념
- 클라이언트와 로드밸런서 사이에 통신하는동안 암호화를 해준다. 이를 in-flight(전송중)암호화 라고한다.
- 송신자와 수신자 측에서만 복호화 할 수 있다
- SSL은 보안 소켓 계층을 으미하고 연결을 안호화 하는데 사용한다
- TLS는 새로운 버전의 SSL로 전송 계층 보안을 의미한다
- 최근에는 TLS 인증서가 주로 사용된다. 하지만 사람들은 여전히 SSL이라고 부른다
- 퍼블릭 인증서는 인증기관(CA : Certificate Authorities)에서 발급한다
- 퍼블릭 SSL인증서를 로드 밸런서에 추가하면, 클라이언트와 로드밸런서 사이의 연결을 암호화할 수 있다
- SSL인증서에는 만료 날짜가 있어서 주기적으로 갱신해 줘야한다
- HTTPS는 SSL인증서를 써서 암호화해 안전하다는 뜻
- 인터넷을 통해 우리 로드 밸런서로 접속하면, 로드밸런서에서는 내부적으로 SSL 종료를 수행한다
- 백엔드와는 HTTP로  통신한다 (암호화x)
- 하지만 VPC로 이동하는 트래픽은 프라이빗 네트워크를 쓰기 때문에 로드밸런서는 x.509 인증서를 사용하는데, 이걸 SSL 또는 TLS 서버 인증서라고 부른다
- AWS에는 인증서들을 관리할 수 있는 ACM이라는게 있다 (aws 인증서 관리자를 의미)
- HTTP리스너를 구성할 때 반드시 HTTPS 리스너로 해야한다
	- 기본 인증서를 지정해줘야한다
	- 다중 도메인을 지원하기 위해 다른 인증서를 추가할 수 있다
	- SNI(서버 이름 지정)라는 걸 써서 접속할 호스트의 이름을 알릴 수 있다


### SNI

- 여러개의 SSL인증서를 하나의 웹 서버에 로드해 하나의 웹 서버가 여러개의 웹 사이트 지원할 수 있게 해준다
- 클라이언트가 대상 서버의 호스트 이름을 지정하도록 한다
- 클라이언트가 접속할 웹사이트를 말했을 때, 서버는 어떤 인증서를 로드해야 하는지 알 수 있다
- 모든 클라이언트가 지원하지 않는다.
- ALB,NLB, CloudFront에서 동작한다 (CLB 지원x)
- 인증서가 여러개라면 ALB or NLB
- CLB를 이용해서 여러개의 인증서를 사용하려면 CLB를 여러개 둬야함


---

## Connection Draining
Deregistration Delay
연결 드레이닝 || 등록 취소 지연

- 인스턴스를 등록 취소, 혹은 비정상 상태일 때 인스턴스에 어느정도 시간을 주어 in-flight 요청 (활성 요청)을 완료 할 수 있도록 하는 기능
- 설정값이 0이면 비활성과 같다
- 파일 업로드 다운로드와 같은 작업은 처리가 완료되기까지 오래걸리니 드레이닝 시간을 오래 주는것이 좋다
- 1~3600초 까지 가능

---

## ASG
오토 스케일링 그룹

웹사이트 방문자가 갈수록 많아지면서 로드가 바뀔 수 있다 이때 사용

- asg는 스케일 아웃 스케일 인 한다
- 최대 최소 갯수를 지정할 수 있다
- 로드 밸런서와 페어링 하는경우 asg에 속한 모든 인스턴스가 로드 밸런서와 연결한다
- 한 인스턴스가 비정상이면 종료하고 새롭게 띄워 연결한다
- asg는 무료이다
- asg를 사용하려면 시작 템플릿을 구성해야한다
	- 시작 템플릿 구성
		- ami
		- 인스턴스 유형
		- ec2사용자 데이터
		- ebs 볼륨
		- 보안 그룹
		- SSH 키 페어
		- ec2 인스턴스의 iam 역할
		- 네트워크 및 서브넷 정보
		- 로드밸런서 정보 등등
		- asg 최대 최소 크기, 용량 스케일링 정책


CloudWatch 경보를 기반으로 asg를 스케일 인 아웃 할 수 있다

---

## ASG 조정 정책

동적
- 추적 스케일링
	- 평균 cpu 사용률을 추적 40%를 유지하도록
- 단순/단계 스케일링
	- 전체 asg에 대한 cpu 사용률이 70%를 초과하는 경우 용량은 두  유닛 추가하도록 설정
	- cpu 사용률이 30% 이하로 떨어지면 유닛을 하나 제거
	- cloudwatch를 사용하는 경우 한번에 추가되고 제거되는 유닛을 단계별로 설정하는게 좋다
- 예측 스케일링
	- 과거의 로드를 보고 예측이 생성된다
	- 머신러닝 기반일것이다


cpu, 요청수, 평균 네트워크 in out 등등의 지표를 사용

### 스케일링 휴지
스케일링 작업이 끝날때마다 기본적으로 5분 또는 300초의 휴지기간을 갖는다. 이때는 asg가 추가 인스턴스를 실행 또는 종료할 수 없다




